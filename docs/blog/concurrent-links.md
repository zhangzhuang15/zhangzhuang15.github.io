---
title: "百万并发？并发连接数上限怎么估计？"
page: true
aside: true
---

# 写在最前面
有一次听到隔壁同事聊到某公司使用4台8G 4core的服务器，支撑1亿的并发量，我感到非常好奇，
4台服务器真的可以做到嘛，太离谱了吧。于是，我就想搞清楚一个问题，一台服务器最多支持多少
个TCP连接？

## TCP连接数
如果不知道如何区别两个TCP连接是否为同一个，那么在估计连接数的时候，就会有问题。

一个TCP连接如何被唯一地确定呢？

参考了一部分博客，我了解到：`一个套接字对唯一标识了一个TCP连接`。

套接字对就是`(源IP地址，源端口号):(目标IP地址，目标端口号)`。

如果有两个TCP连接，上述四个要素中有一个不同，那么这两个就不是同一个TCP连接。

根据套接字对分析，理论上一个服务进程最多可以支持多少个TCP连接？

这里假设服务器只有一个IP地址，服务进程只监听一个端口号。

那么最多连接数就是 2^(32 + 16).
> IP地址是 32 bit位，端口号是 16bit位。

## 理论很多，实际达不到
理论上看，服务进程可以支持非常多的连接，但实际上是做不到那么多的，最大的限制因素就是服务器的内存。

当服务进程启动后，它会生成一个套接字A，监听一个端口号。当有客户端连接时，服务进程会生成一个新的套接字，
该套接字负责和客户端完成数据通讯，同时这个套接字会复用套接字A的端口号。

问题是，每个套接字是一种数据结构，会占用内存，它要把数据传送给客户端，需要占用一部分内存作为网卡数据的
缓存。这些都是内存开销。网上有博客说，在套接字不发生数据传输的情况下，也需要占用3k左右的内存，我们不妨
基于这种说法，做进一步推断，假设套接字需要使用4k的数据缓存，那么一个套接字就要占用7k，每有一次连接，
就形成一个套接字，那么100万连接的话，占用的内存是 100_0000 * 7k = 1000 * 7M = 7G(用1000近似估计
1024， 不严格使用1024计算内存单位的转换)。

也就是说，一个8G内存的服务器最多支持100万连接，那么4台最多就支持400万连接，所以支持1亿连接是不对的。

但是，如果一个连接上处理25个请求（长连接情形），那么4台服务器可以支持1亿请求量。

上述假设中，数据缓存区是4k，在一定范围内，这个值越大，网络传输中读写数据越快，那么一个连接处理25个请求
的时间开销就越少，但我们假定的是4k，也就是说，虽然支持单连接处理25个请求，但这25个请求处理完毕不一定
很快。

## 端口复用问题
这个问题的本质就是发送端和接收端如何区分IP包。

TCP连接发送的包，在网络层就是IP包。IP包里包含很多信息，最重要的就是协议、源IP、源端口号、目标IP、目标端口号。

如果两个服务进程使用同一个端口号，但是IP地址不同（主机有多个网卡），那么这两个服务进程发送的IP包不会混淆。

如果两个服务进程使用同一个端口号，同一个IP地址，客户端发送过来的IP包就没办法甄别，到底该发送给哪个服务进程。

如果两个服务进程，使用同一个端口号，同一个IP地址，但是一个走TCP协议，一个走UDP协议，那么在IP包中，协议字段
就不同，就可以区分这个IP包应该交给哪个服务进程处理，此时复用同一个端口号是可以的。

TCP服务会设置socket的选项 SO_REUSEADDR，允许绑定同一个端口号，这个不能滥用，它解决的是如下两个问题：
- 绑定的 IP地址 + 端口时，只要 IP 地址不是正好(exactly)相同，那么允许绑定

- 如果当前启动进程绑定的 IP+PORT 与处于TIME_WAIT 状态的连接占用的 IP+PORT 存在冲突，但是新启动的进程使用了 SO_REUSEADDR 选项，那么该进程就可以绑定成功

## Reference
[Minimalist Life | 百万并发连接、65536和Linux TCP/IP 性能优化](https://pathbox.github.io/2018/02/06/65535-port-and-concurrent-socket/)

[极兔面试：一台服务器，支持的TCP连接数最大是多少？](https://www.cnblogs.com/crazymakercircle/p/17932862.html)

[知乎 | 一台机器最多能撑多少个TCP连接? 今天掰扯清楚！](https://zhuanlan.zhihu.com/p/290651392)

[知乎 | TCP 和 UDP 可以使用同一个端口吗？](https://zhuanlan.zhihu.com/p/549846414)